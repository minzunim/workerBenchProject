<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <script
    src="https://code.jquery.com/jquery-3.5.1.js"
    integrity="sha256-QWo7LDvxbWT2tbbQ97B53yJnYU3WhH/C8ycbRAkjPDc="
    crossorigin="anonymous"
  ></script>
  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
  <link href="/auth/css/signup.css" rel="stylesheet"/>
    <title>회원가입</title>
  </head>
  <body>
    <%- include('header.ejs') %>
    <div id="signupBox">
        <h1>회원가입</h1>
        <div class="mb-3">
          <label for="email" class="form-label">이메일</label>
          <input type="text" class="form-control" id="email">
        </div>
        <div class="mb-3">
          <label for="password" class="form-label">비밀번호</label>
          <input type="password" class="form-control" id="password"></input>
        </div>
        <div class="mb-3">
          <label for="checkPassword" class="form-label">비밀번호확인</label>
          <input type="password" class="form-control" id="checkPassword"></input>
        </div>
        <div class="btn" id="add-btn">
            <button type="button" id="signupBtn" onclick="checkRegisterInfo()">가입하기</button>
            <div class="modal" id="modal">
                <div class="modal_body ">
                    <div class="password-reset">
                        <h1>이메일로 인증코드를 발송하였습니다.</h1>
                        <div class="mb-3 Certification-Number">
                            <input type="text" class="form-control" id="Certification-Number-input" placeholder="인증번호 입력">
                            <button type="button" id="auth-confirm" onclick="checkCode()">인증 확인</button>
                        </div>
                        <div class="close-btn">
                             <button id="close-btn" onclick="closeModal()">나가기</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
                
  </body>

  <!-- script 구성 -->
  <script>
    // 모달 닫기
    const closeModal = () => {
      const modal = document.querySelector("#modal");
      modal.classList.remove('show');
    }

    // 가입하기 버튼 클릭 시 유효성 검사 및 이메일 인증 코드 발송
    const checkRegisterInfo = async () => {
      const email = document.querySelector("#email").value;
      const password = document.querySelector("#password").value;
      const authentNum = document.querySelector('#checkPassword').value;

      if (!email || !email.includes("@") || !email.includes(".")) {
        alert("이메일을 정확히 입력해 주세요");
        return 
      }
      if (password !== authentNum) {
        alert("패스워드가 일치하지 않습니다.");
        return;
      }
      if (password.length < 4 ) {
        alert("비밀번호가 너무 짧습니다.");
        return
      }
      
      try {
        const res = await axios({
          method: 'POST',
          url: '/api/auth/register',
          data: {email, password, authentNum},
        });
        const modal = document.querySelector("#modal");
        modal.classList.add('show');
      } catch (err) {
        // console.log(err.response.data);   // 서버 측 글로벌 에러 필터에서 리턴한 값이 여기에 담겨 있어.
        alert(`에러 코드: ${err.response.data.statusCode} / message: ${err.response.data.message}`);
      }
    }

    // 이메일 인증 코드 입력 후 서버로 전송. 성공 시 회원가입 완료
    const checkCode = async () => {
      const email = document.querySelector("#email").value;
      const password = document.querySelector("#password").value;
      const emailAuthCode = document.querySelector("#Certification-Number-input").value;

      if (!emailAuthCode) {
        alert("이메일 인증 코드를 입력해 주세요!");
        return;
      }

      try {
        const res2 = await axios({
          method: 'POST',
          url: '/api/auth/register/join',
          data: {email, password, emailAuthCode},
        });
        location.href="/";
      } catch (err) {
        alert(`에러 코드: ${err.response.data.statusCode} / message: ${err.response.data.message}`);
      }

    }
  </script>
</html>
